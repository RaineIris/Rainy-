<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainy é˜…è¯»å™¨</title>
    <style id="font-import-styles"></style>
    <style>
        :root {
            --theme-color: #d94689; /* ä¸»é¢˜ç²‰è‰² */
            --theme-light: #fce3ec; /* æµ…ç²‰ */
            --theme-bg: linear-gradient(135deg, #fce3ec 0%, #e8f0fe 100%);
            --text-dark: #333;
            --text-light: #666;
            --danger-color: #e53e3e; /* åˆ é™¤æŒ‰é’®çº¢è‰² */
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", 'Noto Sans SC', Arial, sans-serif;
            overflow: hidden;
            background-image: var(--theme-bg);
        }

        /* * ======================================
         * V15.0 æ ‡é¢˜ç”»é¢ (é»˜è®¤æ˜¾ç¤º)
         * ======================================
        */
        #title-screen {
            width: 100%; height: 100%;
            display: flex; /* é»˜è®¤æ˜¾ç¤º */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(15px);
            background-color: rgba(255, 255, 255, 0.5);
            /* V19.0 ç¡®ä¿åœ¨æ¸¸æˆå®¹å™¨ä¹‹ä¸Š */
            position: absolute;
            top: 0; left: 0;
            z-index: 28; /* V20.0 è°ƒæ•´: ä½äº 28 */
        }
        #title-screen-logo {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            color: var(--theme-color);
            margin-bottom: 40px;
        }
        #title-screen-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 300px;
            max-width: calc(100% - 40px);
        }
        #title-screen-menu button {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--theme-color);
            color: var(--theme-color);
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        #title-screen-menu button:hover {
            background-color: var(--theme-color);
            color: white;
            transform: scale(1.02);
        }
        /* V15.0 ç¦ç”¨ç»§ç»­æŒ‰é’® */
        #title-screen-menu button:disabled {
            background-color: #ddd;
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }


        /* æ¸¸æˆä¸»å®¹å™¨ (V15.0 é»˜è®¤éšè—) */
        #game-container {
            width: 100%; height: 100%; color: var(--text-dark);
            display: none; /* V15.0 é»˜è®¤éšè— */
            flex-direction: column; justify-content: flex-end;
            position: relative;
        }

        /* ç‚¹å‡»åŒºåŸŸ */
        #click-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; cursor: pointer; }

        /*
         * ======================================
         * èœå•æŒ‰é’®
         * ======================================
        */
        #menu-btn {
            position: absolute; top: 20px; right: 20px;
            z-index: 31; /* V20.0 ä¿®å¤: æ°¸è¿œåœ¨æœ€ä¸Šå±‚ */
            cursor: pointer; padding: 10px;
            width: 44px; height: 44px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 5px;
            backdrop-filter: blur(5px);
            border: 1px solid #ccc;
        }
        #menu-btn .menu-bar { width: 24px; height: 3px; background-color: var(--text-dark); border-radius: 2px; }

        /* é€šç”¨å¼¹çª—èƒŒæ™¯ */
        .modal-backdrop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.0);
            z-index: 30; /* V20.0: ä½äº 30 */
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            transition: background-color 0.3s ease;
        }
        .modal-backdrop.show {
            display: flex;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal-content {
            background-color: #f5f7fa; border-radius: 10px; padding: 0;
            width: calc(100% - 40px); max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header {
            text-align: center; padding: 15px; font-size: 1.5em;
            border-bottom: 1px solid #eee; position: relative;
            background-color: white; color: var(--text-dark);
        }
        
        /* V14.3 ä¿®å¤ï¼šç¾åŒ–å…³é—­æŒ‰é’® */
        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s, transform 0.2s;
        }
        .modal-close-btn:hover {
            background-color: #e0e0e0;
            transform: rotate(90deg);
        }
        .modal-close-btn::before,
        .modal-close-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 2px;
            background-color: #888;
        }
        .modal-close-btn::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .modal-close-btn::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .modal-body { flex: 1; overflow-y: auto; padding: 10px; max-height: 70vh; }
        
        /* å¼¹çª—å†…çš„æŒ‰é’® */
        .modal-body .modal-btn {
            background-color: var(--theme-color); color: white; border: none;
            padding: 12px; border-radius: 8px; cursor: pointer;
            font-size: 1em; font-weight: bold; width: 100%;
            margin-top: 10px;
            transition: background-color 0.2s ease;
        }
        .modal-body .modal-btn.secondary {
            background-color: #e0e0e0;
            color: var(--text-dark);
            border: 1px solid #ccc;
        }
        .modal-body .modal-btn:hover {
            opacity: 0.8;
        }
        .modal-body .modal-btn.secondary:hover {
            background-color: #d0d0d0;
            opacity: 1;
        }
        .modal-body .modal-btn.danger {
            background-color: var(--danger-color); color: white;
        }
        

        /* V11 å‡çº§ï¼šä¸»èœå• (æ»‘å‡ºå¼é¢æ¿) */
        #menu-modal {
            justify-content: flex-end; /* å¼¹çª—å†…å®¹é å³ */
            background-color: transparent;
            overflow: hidden;
        }
        #menu-panel { /* æ›¿æ¢ .modal-content */
            background-color: #f5f7fa;
            width: 300px; max-width: 80%; 
            height: 100%;
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        #menu-modal.show #menu-panel {
            transform: translateX(0); /* æ»‘å…¥ */
        }
        
        #menu-modal .modal-section { padding: 10px; }
        #menu-modal h3 {
            margin: 10px 0 10px 10px; color: var(--text-light); font-size: 1em;
            border-bottom: 1px solid #eee; padding-bottom: 5px;
        }
        
        /* æ•…äº‹ç®¡ç† */
        #story-list { display: flex; flex-direction: column; gap: 10px; }
        .story-item {
            background-color: white; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; cursor: pointer; position: relative;
        }
        .story-item.active { border-left: 5px solid var(--theme-color); }
        .story-name {
            font-weight: bold; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; padding-right: 110px; /* V20.4 ä¸ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }
        .story-delete-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background-color: #fee; color: var(--danger-color); border: 1px solid var(--danger-color);
            border-radius: 5px; padding: 5px 8px; font-size: 0.9em; font-weight: bold; cursor: pointer;
        }
        .story-delete-btn:hover { background-color: var(--danger-color); color: white; }
        
        /* V20.4 ç¼–è¾‘æŒ‰é’® */
        .story-edit-btn {
            position: absolute; right: 55px; top: 50%; transform: translateY(-50%);
            background-color: #eef; color: #44a; border: 1px solid #44a;
            border-radius: 5px; padding: 5px 8px; font-size: 0.9em; font-weight: bold; cursor: pointer;
        }
        .story-edit-btn:hover { background-color: #44a; color: white; }
        
        /* ç« èŠ‚åˆ—è¡¨ */
        .chapter-list {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
            margin-top: 0;
        }
        .story-item.expanded .chapter-list {
            max-height: 200px; /* å±•å¼€ */
            overflow-y: auto; margin-top: 10px;
        }
        .chapter-item {
            padding: 10px; border-top: 1px solid #eee; font-size: 0.9em;
            color: var(--text-light); background-color: #fcfcfc;
        }
        .chapter-item:hover { background-color: #f0f0f0; }
        .chapter-item.section { font-weight: bold; color: var(--text-dark); }
        .chapter-item.scene { padding-left: 20px; }
        
        #import-story-btn {
            width: calc(100% - 20px); margin: 10px; background-color: var(--theme-color);
            color: white; border: none; padding: 15px; border-radius: 8px;
            cursor: pointer; font-size: 1em; font-weight: bold;
        }

        /* æ¸¸æˆæ§åˆ¶ */
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #game-controls button {
            background-color: white; border: 1px solid #ccc; color: var(--text-dark);
            padding: 15px 10px; border-radius: 8px; cursor: pointer; font-size: 1em;
            transition: background-color 0.2s;
        }
        #game-controls button:hover { background-color: #f0f0f0; }
        #game-controls button.active {
            background-color: #ff85b3; border-color: #ff85b3; color: white;
        }

        /* 5. åœºæ™¯æ ‡é¢˜ (å·¦ä¸Šè§’) */
        #scene-title {
            position: absolute; top: 20px; left: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--text-light); padding: 5px 12px; border-radius: 15px;
            font-size: 16px; z-index: 5; transition: opacity 0.3s ease;
            opacity: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
        }
        #scene-title.show { opacity: 1; }

        /* 6. å¯¹è¯æ¡† */
        #dialogue-box {
            width: calc(100% - 40px); margin: 20px; padding: 20px;
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px; min-height: 150px; position: relative;
            z-index: 5; transition: opacity 0.3s ease;
            opacity: 0; backdrop-filter: blur(10px);
            
            /* V20.6 è®¾ä¸º Flex å¸ƒå±€ */
            display: flex;
            flex-direction: column;
            /* é»˜è®¤ (å¯¹è¯) é¡¶éƒ¨å¯¹é½ */
            justify-content: flex-start;
        }
        #dialogue-box.show { opacity: 1; }

        /* 7. è§’è‰²åç§° */
        #character-name {
            color: var(--theme-color); font-size: 1.2em; font-weight: bold;
            margin-bottom: 15px; min-height: 1.2em;
            /* V20.5 è¿½åŠ ï¼šãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
            transition: margin-bottom 0.2s ease, min-height 0.2s ease, opacity 0.2s ease;
            opacity: 1;
        }
        
        /* V20.5 è¿½åŠ ï¼šæ—ç™½æ¨¡å¼ */
        #dialogue-box.name-hidden #character-name {
            min-height: 0;
            margin-bottom: 0;
            opacity: 0; /* éšè— */
        }
        /* V20.6 æ—ç™½æ¨¡å¼ä¸‹å‚ç›´å±…ä¸­ */
        #dialogue-box.name-hidden {
            justify-content: center;
        }
        
        /* 8. å¯¹è¯æ–‡æœ¬ */
        #dialogue-text {
            font-size: 1.1em; line-height: 1.6; white-space: pre-wrap; min-height: 50px;
        }
        #dialogue-text::after { content: '|'; opacity: 1; animation: blink 0.7s infinite; }
        #dialogue-text.completed::after { content: ''; animation: none; opacity: 0; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /*
         * ======================================
         * V14 å‡çº§ï¼šç« èŠ‚æ ‡é¢˜åŠ¨ç”» (è‰ºæœ¯å­—)
         * ======================================
        */
        @keyframes title-char-fly-in {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        #section-title {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95); color: var(--text-dark);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; z-index: 20; opacity: 0; visibility: hidden;
            cursor: pointer;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        #section-title.show { 
            opacity: 1; 
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s 0s;
        }
        #section-title h1 { 
            font-size: 2.5em; margin: 0;
            /* ä¸ºåŠ¨ç”»å‡†å¤‡ */
            perspective: 300px;
        }
        /* è‰ºæœ¯å­—åŠ¨ç”»çš„span */
        #section-title h1 span {
            display: inline-block;
            opacity: 0;
            animation: title-char-fly-in 0.5s ease-out forwards;
        }
        #section-title h2 { font-size: 1.5em; font-weight: normal; color: var(--text-light); }

        /* 10. å†å²è®°å½• (Log) å¼¹çª— */
        #log-content { flex: 1; overflow-y: auto; padding: 20px; }
        .log-entry { margin-bottom: 15px; }
        .log-character { color: var(--theme-color); font-weight: bold; margin-bottom: 5px; }
        .log-text { font-size: 1.1em; color: var(--text-dark); padding-left: 10px; border-left: 3px solid var(--theme-light); }

        /* 11. åœºæ™¯åˆ‡æ¢åŠ¨ç”» (v3) */
        #scene-transition {
            position: absolute; top: 50%; left: 0; width: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 15; transform: translateY(-50%);
            pointer-events: none; opacity: 0; cursor: pointer;
            transition: opacity 0.5s ease;
        }
        #scene-transition-text {
            background-color: rgba(217, 70, 137, 0.85); color: white;
            padding: 12px 30px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 1.2em; transform: translateX(-100vw);
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.5s ease;
            position: relative; overflow: hidden;
        }
        #scene-transition-text::before,
        #scene-transition-text::after {
            content: ''; position: absolute; width: 50px; height: 200%;
            background-color: rgba(255, 255, 255, 0.15);
            transform: rotate(-30deg);
        }
        #scene-transition-text::before { top: -50%; left: -20px; }
        #scene-transition-text::after { top: -50%; left: 40px; }
        #scene-transition.show { opacity: 1; pointer-events: auto; }
        
        #scene-transition.slide-out {
            opacity: 0;
        }
        #scene-transition.slide-out #scene-transition-text {
            transform: translateX(100vw);
        }

        /* 12. å­˜è¯»æ¡£å¼¹çª— */
        .save-slot { background-color: white; border: 1px solid #ddd; border-radius: 10px; margin: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: background-color 0.2s ease; }
        .save-slot:hover { background-color: #f9f9f9; }
        .save-slot.empty { text-align: center; color: var(--text-light); padding: 30px 15px; font-style: italic; }
        .slot-header { display: flex; justify-content: space-between; align-items: center; }
        
        .slot-header-left { 
            font-weight: bold; 
            font-size: 1.1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        .slot-header-right { 
            display: flex; 
            align-items: center; 
            gap: 10px;
            flex-shrink: 0;
        }
        .slot-time { 
            font-size: 0.9em; 
            font-weight: normal; 
            color: var(--text-light); 
        }
        .slot-rename-btn {
            font-size: 1.1em;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .slot-rename-btn:hover {
            background-color: #eee;
        }
        
        .slot-chapter { margin-top: 8px; color: var(--theme-color); font-weight: bold; }
        .slot-line { margin-top: 5px; color: var(--text-dark); font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 13. é€Ÿåº¦é€‰æ‹©å¼¹çª— */
        #speed-modal .modal-body { padding: 20px; }
        #speed-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        #speed-options button {
            background-color: #f0f0f0; border: 1px solid #ddd; color: var(--text-dark);
            padding: 10px; border-radius: 5px; cursor: pointer; font-size: 1em;
        }
        #speed-options button:hover { background-color: #e0e0e0; }
        #speed-cancel-btn {
            width: 100%; background-color: #aaa; color: white; border: none;
            padding: 10px; border-radius: 5px; cursor: pointer; font-size: 1em;
        }
        
        /* V16.0 è®¾ç½®å¼¹çª— (å­—ä½“é‡æ„) */
        #settings-modal .modal-body { padding: 20px; }
        #settings-modal h4 { margin-top: 0; margin-bottom: 10px; }
        #settings-modal p { font-size: 0.9em; color: var(--text-light); margin-top: 0; }
        
        /* V16.0 å­—ä½“ç®¡ç† */
        .font-manager-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        #font-select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: white;
        }
        #font-delete-btn {
            padding: 0 12px;
            border: 1px solid var(--danger-color);
            background: #fee;
            color: var(--danger-color);
            border-radius: 5px;
            cursor: pointer;
        }
        .font-add-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            margin: 20px 0;
        }
        .font-add-group input {
            width: calc(100% - 20px); /* 100% - padding */
            border: 1px solid #ccc;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        /* V16.0 å­—ä½“ CSS æ–‡æœ¬æ¡† */
        .font-add-group textarea {
            width: calc(100% - 20px);
            border: 1px solid #ccc;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            resize: vertical;
        }
        
        #convert-file-input {
            width: calc(100% - 22px); /* 100% - padding/border */
            border: 1px solid #ccc;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* V19.0 AI è½¬æ¢å¸®åŠ© */
        #ai-convert-help {
            font-size: 0.9em;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
        }
        #ai-convert-help p {
            margin-top: 0;
            color: var(--text-light);
        }
        #ai-convert-help details {
            background: #fff;
            border-radius: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        #ai-convert-help summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--text-dark);
        }
        #ai-convert-help pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
        }
        /* V20.0 ä¿®å¤: å¤åˆ¶æŒ‰é’®æ ·å¼ */
        #copy-prompt-btn {
            background-color: var(--theme-color);
            color: white;
            width: auto;
            padding: 8px 12px;
            font-size: 0.9em;
        }
        #copy-prompt-btn:hover {
            opacity: 0.8;
        }
        
        
        /* V14.8 AI è½¬æ¢ Loading */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
        }
        
        /* V14.8 è½¬æ¢ç»“æœå¼¹çª— */
        #convert-result-modal .modal-body {
            text-align: center;
            padding: 20px;
        }
        #convert-result-modal h3 {
            margin-top: 0;
        }
        /* V20.3 CSS ä¿®å¤ */
        #convert-result-controls {
            display: grid; /* V20.3 æ”¹ä¸º grid */
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        /* V20.3 ç¼–è¾‘æŒ‰é’® */
        #convert-edit-btn {
            grid-column: 1 / -1; /* å æ»¡æ•´è¡Œ */
            margin-top: 0;
        }
        
        /* V20.3 è½¬æ¢ç¼–è¾‘å¼¹çª— */
        #edit-story-modal .modal-content {
            width: calc(100% - 20px);
            max-width: 600px;
        }
        #edit-story-textarea {
            width: 100%;
            height: 60vh;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            box-sizing: border-box;
        }
        #edit-story-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* V20.4 æ•°æ®åº“æ•…äº‹ç¼–è¾‘å¼¹çª— */
        #edit-db-story-modal .modal-content {
            width: calc(100% - 20px);
            max-width: 600px;
        }
        #edit-db-story-textarea {
            width: 100%;
            height: 60vh;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            box-sizing: border-box;
        }
        #edit-db-story-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* V19.0 æ•…äº‹ç»“æŸç”»é¢ */
        #story-end-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 26; /* V20.0: ä½äºèœå• (31) é«˜äºæ¸¸æˆ (25) */
            display: none; /* é»˜è®¤éšè— */
            justify-content: center;
            align-items: center;
        }
        #story-end-btn {
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--theme-color);
            color: var(--theme-color);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        #story-end-btn:hover {
            background-color: var(--theme-color);
            color: white;
        }

    </style>
</head>
<body>
    
    <div id="title-screen">
        <div id="title-screen-logo">Rainy é˜…è¯»å™¨</div>
        <div id="title-screen-menu">
            <button id="title-continue-btn" disabled>ç»§ç»­æ¸¸æˆ</button>
            <button id="title-start-btn">é‡æ–°å¼€å§‹</button>
            <button id="title-load-btn">è¯»å–å­˜æ¡£</button>
            <button id="title-story-list-btn">åˆ‡æ¢æ•…äº‹</button> <button id="title-settings-btn">æ¸¸æˆè®¾ç½®</button>
        </div>
    </div>

    <div id="game-container">
        
        <div id="menu-btn">
            <div class="menu-bar"></div>
            <div class="menu-bar"></div>
            <div class="menu-bar"></div>
        </div>

        <div id="scene-title"></div>

        <div id="dialogue-box">
            <div id="character-name"></div>
            <div id="dialogue-text"></div> 
        </div>

        <div id="click-area"></div>
        
        <div id="scene-transition">
            <span id="scene-transition-text"></span>
        </div>
    </div>

    <div id="section-title">
        <h1 id="section-title-main"></h1>
        <h2 id="section-title-sub"></h2>
    </div>
    
    <div id="story-end-screen">
        <button id="story-end-btn">è¿”å›æ ‡é¢˜</button>
    </div>

    <div class="modal-backdrop" id="menu-modal">
        <div id="menu-panel">
            <div class="modal-header">
                èœå•
                <span class="modal-close-btn" data-modal-id="menu-modal"></span>
            </div>
            <div class="modal-body" style="padding-top: 0;"> <div id="story-manager">
                    <h3>æ•…äº‹åˆ—è¡¨</h3>
                    <div id="story-list">
                        </div>
                    <button id="import-story-btn">å¯¼å…¥æ–°æ•…äº‹ (.txt)</button>
                    <input type="file" id="import-file-input" accept=".txt" style="display: none;">
                </div>
                
                <div id="game-controls-section">
                    <h3>æ¸¸æˆæ§åˆ¶</h3>
                    <div id="game-controls">
                        <button id="save-btn">å­˜æ¡£</button>
                        <button id="load-btn">è¯»æ¡£</button>
                        <button id="log-btn">å†å²</button>
                        <button id="title-btn">è¿”å›æ ‡é¢˜</button>
                        <button id="auto-btn">Auto</button>
                        <button id="skip-btn">å¿«è¿›</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="log-modal">
        <div class="modal-content">
            <div class="modal-header">
                å†å²è®°å½•
                <span class="modal-close-btn" data-modal-id="log-modal"></span>
            </div>
            <div class="modal-body" id="log-content">
                </div>
        </div>
    </div>

    <div class="modal-backdrop" id="save-load-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="save-load-title">æ•°æ®ç®¡ç†</span>
                <span class="modal-close-btn" data-modal-id="save-load-modal"></span>
            </div>
            <div class="modal-body" id="save-load-content">
                </div>
        </div>
    </div>

    <div class="modal-backdrop" id="speed-modal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-header">
                <h3 id="speed-modal-title" style="margin: 0; font-size: 1.2em;">è®¾ç½®é€Ÿåº¦</h3>
            </div>
            <div class="modal-body" id="speed-options-body">
                <div id="speed-options">
                    </div>
                <button id="speed-cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    
    <div class="modal-backdrop" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                æ¸¸æˆè®¾ç½®
                <span class="modal-close-btn" data-modal-id="settings-modal"></span>
            </div>
            <div class="modal-body">
                <h4>å­—ä½“è®¾ç½®</h4>
                <p>ç®¡ç†å’Œåˆ‡æ¢é˜…è¯»å™¨å­—ä½“ã€‚</p>
                <div class="font-manager-group">
                    <select id="font-select">
                        <option value="DEFAULT_SYSTEM_FONT">é»˜è®¤ç³»ç»Ÿå­—ä½“</option>
                    </select>
                    <button id="font-delete-btn">åˆ é™¤</button>
                </div>
                
                <div class="font-add-group">
                    <input type="text" id="font-name-input" placeholder="å­—ä½“æ˜µç§° (e.g., å¿«ä¹å­—ä½“)">
                    <textarea id="font-css-input" rows="5" placeholder="åœ¨æ­¤ç²˜è´´å®Œæ•´çš„ CSS ä»£ç ï¼Œä¾‹å¦‚ï¼š&#10;@import url(...);&#10;body { font-family: '...'; }"></textarea>
                    <button id="font-save-btn" class="modal-btn secondary">ä¿å­˜å¹¶åº”ç”¨å­—ä½“</button>
                </div>
                
                <button id="font-default-btn" class="modal-btn secondary">æ¢å¤é»˜è®¤å­—ä½“</button>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                
                <h4>AI å‰§æƒ…æ ¼å¼è½¬æ¢</h4>
                <p>ä¸Šä¼ éæ ‡å‡†æ ¼å¼çš„ .txt, .md, .rtf æ–‡ä»¶ã€‚</p>
                <input type="file" id="convert-file-input" accept=".txt,.md,.rtf">
                <button id="convert-start-btn" class="modal-btn">å¼€å§‹è½¬æ¢</button>
                
                <div id="ai-convert-help">
                    <p><b>æç¤ºï¼š</b>ä¸æ”¯æŒ .docx æ–‡ä»¶ã€‚è¯·å…ˆå°† .docx ç”¨ Word å¦å­˜ä¸º .rtf æˆ– .txtï¼Œæˆ–ä½¿ç”¨å…¶ä»– AI è½¬æ¢ã€‚</p>
                    <button id="copy-prompt-btn" class="modal-btn">ğŸ“‹ å¤åˆ¶è½¬æ¢æç¤ºè¯</button>
                    <details>
                        <summary>å±•å¼€/æ”¶èµ·æç¤ºè¯</summary>
                        <pre id="prompt-pre-block"></pre>
                    </details>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="convert-result-modal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-body">
                <h3>è½¬æ¢æˆåŠŸï¼</h3>
                <p>å·²æˆåŠŸå¤„ç†å‰§æƒ…æ–‡æœ¬ï¼Œè¯·é€‰æ‹©æ“ä½œï¼š</p>
                <div id="convert-result-controls">
                    <button id="convert-download-btn" class="modal-btn secondary">ä¸‹è½½æ–‡ä»¶</button>
                    <button id="convert-import-btn" class="modal-btn">ç›´æ¥å¯¼å…¥</button>
                    <button id="convert-edit-btn" class="modal-btn secondary">äºŒæ¬¡ç¼–è¾‘</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="edit-story-modal">
        <div class="modal-content">
            <div class="modal-header">
                ç¼–è¾‘è½¬æ¢ç»“æœ
                <span class="modal-close-btn" data-modal-id="edit-story-modal"></span>
            </div>
            <div class="modal-body">
                <p style="margin-top:0; font-size: 0.9em; color: var(--text-light);">è¯·åœ¨æ­¤å¤„æ‰‹åŠ¨ä¿®æ­£æ ¼å¼ï¼Œç„¶åç‚¹å‡»â€œä¿å­˜ä¿®æ”¹â€ã€‚</p>
                <textarea id="edit-story-textarea"></textarea>
                <div id="edit-story-controls">
                    <button id="edit-story-cancel-btn" class="modal-btn secondary">å–æ¶ˆ</button>
                    <button id="edit-story-save-btn" class="modal-btn">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="edit-db-story-modal">
        <div class="modal-content">
            <div class="modal-header">
                ç¼–è¾‘æ•…äº‹
                <span class="modal-close-btn" data-modal-id="edit-db-story-modal"></span>
            </div>
            <div class="modal-body">
                <p style="margin-top:0; font-size: 0.9em; color: var(--text-light);">ä¿®æ”¹åè¯·ä¿å­˜ã€‚å¦‚æœä¿®æ”¹çš„æ˜¯å½“å‰æ­£åœ¨ç©çš„æ•…äº‹ï¼Œå°†è¿”å›æ ‡é¢˜ç”»é¢ã€‚</p>
                <textarea id="edit-db-story-textarea"></textarea>
                <div id="edit-db-story-controls">
                    <button id="edit-db-story-cancel-btn" class="modal-btn secondary">å–æ¶ˆ</button>
                    <button id="edit-db-story-save-btn" class="modal-btn">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>
   
    <div id="loading-overlay">
        æ­£åœ¨è°ƒç”¨ AI è½¬æ¢æ ¼å¼...
    </div>


    <script>
        // ----------------------------------------
        // V20.6 è„šæœ¬ (ä¿®å¤æ—ç™½å±…ä¸­)
        // ----------------------------------------
        
        // ----------------------------------------
        // 0. å‰§æƒ…æ ¼å¼å®šä¹‰ (ä¸å˜)
        // ----------------------------------------
        const DEFAULT_STORY_NAME = "è¯•é˜…æ•…äº‹";
        const DEFAULT_STORY_TEXT = `
# è¯•é˜…æ•…äº‹
## åºç« ï¼šä¸€ä¸ªå®‰é™çš„åˆå
æ—ç™½: è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è¯•é˜…æ–‡æœ¬ï¼Œç”¨äºæµ‹è¯•é˜…è¯»å™¨åŠŸèƒ½ã€‚
è§’è‰²A: æ ‡é¢˜æœ‰åŠ¨ç”»äº†ï¼Œè€Œä¸”Auto/Skipéƒ½ä¿®å¥½äº†ï¼
è§’è‰²B: åœºæ™¯åˆ‡æ¢ä¹Ÿä¸é”äº†ï¼Œæ‰‹æ„Ÿä¸æ»‘ï¼
æ—ç™½: (ä»–ä»¬çœ‹èµ·æ¥å¯¹v20ç‰ˆæœ¬å¾ˆæ»¡æ„ã€‚)
## ç»ˆç« ï¼šæ–°çš„å¼€å§‹
è§’è‰²A: é‚£ä¹ˆï¼Œæµ‹è¯•ç»“æŸï¼
è§’è‰²B: æœŸå¾…å¯¼å…¥çœŸæ­£çš„VBSæ•…äº‹ï¼
`;

        window.addEventListener('DOMContentLoaded', () => {

            // ----------------------------------------
            // 2. è·å–å…ƒç´ 
            // ----------------------------------------
            // V15.0 å®¹å™¨
            const titleScreen = document.getElementById('title-screen');
            const gameContainer = document.getElementById('game-container');
            
            // æ¸¸æˆå†…
            const clickArea = document.getElementById('click-area');
            const dialogueBox = document.getElementById('dialogue-box');
            const characterName = document.getElementById('character-name');
            const dialogueText = document.getElementById('dialogue-text'); 
            const sceneTitle = document.getElementById('scene-title');
            
            const sectionTitle = document.getElementById('section-title');
            const sectionTitleMain = document.getElementById('section-title-main');
            const sectionTitleSub = document.getElementById('section-title-sub');
            
            // V19.0 æ•…äº‹ç»“æŸ
            const storyEndScreen = document.getElementById('story-end-screen');
            const storyEndBtn = document.getElementById('story-end-btn');

            // èœå•
            const menuBtn = document.getElementById('menu-btn');
            const menuModal = document.getElementById('menu-modal');
            const menuPanel = document.getElementById('menu-panel');
            const storyList = document.getElementById('story-list');
            const importStoryBtn = document.getElementById('import-story-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            // æŒ‰é’®
            const logBtn = document.getElementById('log-btn');
            const autoBtn = document.getElementById('auto-btn');
            const skipBtn = document.getElementById('skip-btn');
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            const titleBtn = document.getElementById('title-btn');

            // å¼¹çª—
            const allModals = document.querySelectorAll('.modal-backdrop');
            const allCloseBtns = document.querySelectorAll('.modal-close-btn');
            const logModal = document.getElementById('log-modal');
            const logContent = document.getElementById('log-content');
            const saveLoadModal = document.getElementById('save-load-modal');
            const saveLoadTitle = document.getElementById('save-load-title');
            const saveLoadContent = document.getElementById('save-load-content');
            const speedModal = document.getElementById('speed-modal');
            const speedModalTitle = document.getElementById('speed-modal-title');
            const speedOptions = document.getElementById('speed-options');
            const speedCancelBtn = document.getElementById('speed-cancel-btn');
            
            // åœºæ™¯åˆ‡æ¢
            const sceneTransition = document.getElementById('scene-transition');
            const sceneTransitionText = document.getElementById('scene-transition-text');
            
            // V16.0 æ ‡é¢˜ç”»é¢
            const titleContinueBtn = document.getElementById('title-continue-btn');
            const titleStartBtn = document.getElementById('title-start-btn');
            const titleLoadBtn = document.getElementById('title-load-btn');
            const titleStoryListBtn = document.getElementById('title-story-list-btn'); // V16.0
            const titleSettingsBtn = document.getElementById('title-settings-btn');
            
            // V16.0 è®¾ç½® (AI + å­—ä½“)
            const settingsModal = document.getElementById('settings-modal');
            const convertFileInput = document.getElementById('convert-file-input');
            const convertStartBtn = document.getElementById('convert-start-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // V20.3 AIè½¬æ¢å¼¹çª—
            const convertResultModal = document.getElementById('convert-result-modal');
            const convertDownloadBtn = document.getElementById('convert-download-btn');
            const convertImportBtn = document.getElementById('convert-import-btn');
            const convertEditBtn = document.getElementById('convert-edit-btn'); // V20.3
            
            // V20.3 AIè½¬æ¢ç¼–è¾‘å¼¹çª—
            const editStoryModal = document.getElementById('edit-story-modal');
            const editStoryTextarea = document.getElementById('edit-story-textarea');
            const editStorySaveBtn = document.getElementById('edit-story-save-btn');
            const editStoryCancelBtn = document.getElementById('edit-story-cancel-btn');
            
            // V20.4 æ•°æ®åº“æ•…äº‹ç¼–è¾‘å¼¹çª—
            const editDbStoryModal = document.getElementById('edit-db-story-modal');
            const editDbStoryTextarea = document.getElementById('edit-db-story-textarea');
            const editDbStorySaveBtn = document.getElementById('edit-db-story-save-btn');
            const editDbStoryCancelBtn = document.getElementById('edit-db-story-cancel-btn');
            
            // V19.0 AI å¸®åŠ©
            const copyPromptBtn = document.getElementById('copy-prompt-btn');
            const promptPreBlock = document.getElementById('prompt-pre-block');
            
            const fontImportStyles = document.getElementById('font-import-styles');
            const fontSelect = document.getElementById('font-select');
            const fontDeleteBtn = document.getElementById('font-delete-btn');
            const fontNameInput = document.getElementById('font-name-input');
            const fontCssInput = document.getElementById('font-css-input'); // V16.0
            const fontSaveBtn = document.getElementById('font-save-btn');
            const fontDefaultBtn = document.getElementById('font-default-btn');


            // ----------------------------------------
            // 3. çŠ¶æ€å˜é‡
            // ----------------------------------------
            let storyData = [];
            let currentStoryName = DEFAULT_STORY_NAME;
            let currentLine = 0;
            let logHistory = [];
            
            // æ¸¸æˆçŠ¶æ€
            let gameState = 'idle'; // idle, typing, section, scene, modal
            let isAnimationLocked = false;
            
            // Auto
            let autoMode = false;
            let autoTimeout;
            const autoSpeeds = { 1: 1500, 2: 750 };
            const autoSpeedLabels = { 1: 'x1 (ä¸­)', 2: 'x2 (å¿«)' };
            let currentAutoSpeed = autoSpeeds[1];
            
            // Skip
            let skipMode = false;
            let skipTimeout;
            const skipSpeeds = { 1: 400, 2: 200, 3: 50 };
            const skipSpeedLabels = { 1: 'x1 (æ…¢)', 2: 'x2 (ä¸­)', 3: 'x3 (å¿«)' };
            let currentSkipSpeed = skipSpeeds[1];
            
            // å­˜è¯»æ¡£
            const SAVE_KEY_PREFIX = 'vbsReaderSave_';
            const STORY_DB_KEY = 'vbsReaderStoryDB';
            const LAST_STORY_KEY = 'vbsReaderLastStory';
            const TOTAL_SAVE_SLOTS = 5;
            let currentSaveLoadMode = 'save';
            let currentSpeedSetMode = 'auto';
            
            // V14.8 åœºæ™¯è‡ªåŠ¨æ¶ˆå¤±
            let sceneTimeout; 
            
            // V15.0 å­—ä½“
            const FONT_DB_KEY = 'rainyReaderFontDB';
            const LAST_FONT_KEY = 'rainyReaderLastFont';
            const LAST_POS_PREFIX = 'rainyReaderLastPosition_';
            const DEFAULT_FONT_VALUE = 'DEFAULT_SYSTEM_FONT'; // V17.0
            
            // V14.8 AI è½¬æ¢
            let convertedStoryText = '';
            
            // V20.3 æ›´æ–° AI æç¤º
            const AI_CONVERT_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„å‰§æƒ…æ ¼å¼è½¬æ¢åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ¥æ”¶ç”¨æˆ·æä¾›çš„ä»»ä½•æ ¼å¼çš„å‰§æƒ…æ–‡æœ¬ï¼Œå¹¶å°†å…¶ä¸¥æ ¼è½¬æ¢ä¸ºç‰¹å®šæ ¼å¼çš„ .txt æ–‡ä»¶å†…å®¹ã€‚

**ç›®æ ‡æ ¼å¼è§„åˆ™ï¼š**

1.  **ç« èŠ‚ (Section):**
    * ä»¥ \`# \` (\`#\`å· + ç©ºæ ¼) å¼€å¤´ã€‚
    * å¦‚æœæœ‰å‰¯æ ‡é¢˜ï¼Œä½¿ç”¨ \` | \` (ç©ºæ ¼ + \`|\` + ç©ºæ ¼) åˆ†éš”ã€‚
    * ç¤ºä¾‹: \`# ç¬¬ä¸€ç«  | ç ´æ™“\`

2.  **åœºæ™¯ (Scene):**
    * ä»¥ \`## \` (\`##\`å· + ç©ºæ ¼) å¼€å¤´ã€‚
    * ç¤ºä¾‹: \`## æ•™å®¤ - ç™½å¤©\`

3.  **å¯¹è¯ (Character):**
    * æ ¼å¼ä¸º \`è§’è‰²å: \` (è§’è‰²å + è‹±æ–‡å†’å· + ç©ºæ ¼)ã€‚
    * ç¤ºä¾‹: \`æ: æ—©ä¸Šå¥½ï¼\`

4.  **æ—ç™½ (Narration):**
    * ç»Ÿä¸€ä½¿ç”¨ \`æ—ç™½: \` (æ—ç™½ + è‹±æ–‡å†’å· + ç©ºæ ¼)ã€‚
    * ç¤ºä¾‹: \`æ—ç™½: é˜³å…‰é€è¿‡çª—æˆ·æ´’äº†è¿›æ¥ã€‚\`

**è½¬æ¢è¦æ±‚ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)ï¼š**

* **æ™ºèƒ½ç”Ÿæˆåœºæ™¯ (é‡è¦):** å³ä½¿åŸæ–‡æ²¡æœ‰æ˜ç¡®çš„åœºæ™¯æ ‡è®°ï¼ˆå¦‚ \`[åœ°ç‚¹]\`ï¼‰ï¼Œä½ ä¹Ÿå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡ï¼ˆå¦‚ç¯å¢ƒæè¿°ã€æ—¶é—´å˜åŒ–ï¼‰**ä¸»åŠ¨ç”Ÿæˆ** \`## \` æ ¼å¼çš„åœºæ™¯æ ‡é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå‰§æƒ…ä»â€œæ•™å®¤â€è½¬åˆ°â€œèµ°å»Šâ€ï¼Œä½ å¿…é¡»åœ¨ä¸­é—´æ’å…¥ \`## èµ°å»Š\`ã€‚
* **å¼•å·å³å¯¹è¯ (é‡è¦):** ä»»ä½•è¢«ä¸­æ–‡å¼•å·ï¼ˆ\`â€œ...â€\` \`â€˜...â€™\`ï¼‰æˆ–è‹±æ–‡å¼•å·ï¼ˆ\`"..."\` \`'...' \`ï¼‰åŒ…è£¹çš„æ–‡æœ¬ï¼Œ**å¿…é¡»**è¢«è§†ä¸ºå¯¹è¯ã€‚
* **æ™ºèƒ½å¡«å……å¯¹è¯äºº (é‡è¦):** å¦‚æœå¼•å·å†…çš„å¯¹è¯æ²¡æœ‰æ˜ç¡®çš„è¯´è¯äººï¼Œä½ **å¿…é¡»**æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­å‡ºåˆç†çš„ \`è§’è‰²å: \` å¹¶æ·»åŠ åˆ°å¯¹è¯å‰ã€‚å¦‚æœå®åœ¨æ— æ³•æ¨æ–­ï¼Œæ‰å…è®¸ä½¿ç”¨ \`æ—ç™½: \` æ ¼å¼æ¥åŒ…è£¹å¸¦å¼•å·çš„å¥å­ã€‚
* **è½¬æ¢æ—ç™½ï¼š** å°†æ‰€æœ‰åŸæ–‡ä¸­æ²¡æœ‰è§’è‰²åã€ä¸”*ä¸*åœ¨å¼•å·å†…çš„æè¿°æ€§æ®µè½ã€å¿ƒç†æ´»åŠ¨ï¼ˆå¦‚ \`(...)\`ï¼‰éƒ½è½¬æ¢ä¸º \`æ—ç™½: \` æ ¼å¼ã€‚
* **æ¸…ç†æ ¼å¼ï¼š** æ¥æºå¯èƒ½æ˜¯ .md æˆ– .rtf æ–‡ä»¶ï¼Œå¯èƒ½åŒ…å« *, #, \\, {} ç­‰æ ¼å¼åŒ–å­—ç¬¦ã€‚è¯·åœ¨è½¬æ¢æ—¶å¿½ç•¥å¹¶æ¸…ç†æ‰è¿™äº›æ— å…³ç¬¦å·ã€‚
* **ä¿æŒç®€æ´ï¼š** æœ€ç»ˆè¾“å‡ºä¸­ä¸åº”åŒ…å«ä»»ä½•åŸå§‹æ ¼å¼æˆ–å¤šä½™çš„ç©ºè¡Œã€‚`;


            // ----------------------------------------
            // 4. æ ¸å¿ƒåŠŸèƒ½ï¼šæ¨è¿› (V20.0 ä¿®å¤)
            // ----------------------------------------
            
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            // V20.0 æ ¸å¿ƒå‡½æ•°ï¼šæ‰§è¡Œä¸‹ä¸€æ­¥
            async function runNextStep() {
                // 1. æ£€æŸ¥å¼¹çª—
                if (gameState === 'modal') return;

                // 2. ä¼˜å…ˆå¤„ç†æ‰“å­—
                if (gameState === 'typing') {
                    skipTyping();
                } 
                
                // 3. æ£€æŸ¥ä¸å¯ä¸­æ–­çš„åŠ¨ç”»é”
                else if (isAnimationLocked) {
                     return;
                }

                // 4. å¤„ç†å…¶ä»–çŠ¶æ€
                else if (gameState === 'scene') {
                    clearTimeout(sceneTimeout);
                    
                    // éšè—åœºæ™¯ (å³æ»‘æ¶ˆå¤±)
                    isAnimationLocked = true;
                    sceneTransition.classList.add('slide-out');
                    await wait(500); // ç­‰å¾…æ»‘å‡º
                    sceneTransition.classList.remove('show', 'slide-out');
                    sceneTransitionText.style.transform = 'translateX(-100vw)';
                    isAnimationLocked = false;
                    gameState = 'idle';
                    
                    // éšè—å®Œï¼Œé©¬ä¸Šæ˜¾ç¤ºä¸‹ä¸€è¡Œ
                    await showNextLine();
                    
                } else if (gameState === 'section') {
                    // ç« èŠ‚æ ‡é¢˜æ˜¯é”å®šçš„ï¼Œç‚¹å‡»æ— æ•ˆ
                    return;
                } else if (gameState === 'idle') {
                    // ç©ºé—²æ—¶ï¼Œæ˜¾ç¤ºä¸‹ä¸€è¡Œ
                    await showNextLine();
                }
                
                // V20.0 ä¿®å¤ï¼š
                // ä»…å½“ showNextLine æ‰§è¡Œå®Œæ¯•åï¼ŒçŠ¶æ€ä»ç„¶æ˜¯ idle 
                // (å³æ˜¾ç¤ºäº†å¯¹è¯å¹¶æ‰“å®Œäº†å­—) 
                // æ‰è§¦å‘ä¸‹ä¸€æ¬¡ Auto/Skipã€‚
                // å¦‚æœæ˜¯ 'scene' æˆ– 'section'ï¼Œå®ƒä»¬è‡ªå·±ç®¡ç†
                if (gameState === 'idle') {
                    triggerAutoOrSkip();
                }
            }

            // V19.0 æ ¸å¿ƒå‡½æ•°ï¼šæ˜¾ç¤ºå†…å®¹ (V20.5 ä¿®å¤)
            async function showNextLine() {
                if (currentLine >= storyData.length) {
                    stopAuto(); stopSkip();
                    // V19.0 ä¿®å¤ï¼šæ•…äº‹ç»“æŸ
                    storyEndScreen.style.display = 'flex';
                    localStorage.setItem(LAST_POS_PREFIX + currentStoryName, 0); // æ ‡è®°ä¸ºå·²å®Œæˆ
                    return;
                }
                
                const line = storyData[currentLine];
                currentLine++; // ç«‹åˆ»æ¨è¿›

                if (line.type === 'section') {
                    dialogueBox.classList.remove('show');
                    sceneTitle.classList.remove('show');
                    
                    await animateSectionTitle(line.main, line.sub || '');
                    
                    gameState = 'section';
                    isAnimationLocked = true;
                    
                    await wait(1800); // é”1.8ç§’
                    
                    sectionTitle.classList.remove('show');
                    isAnimationLocked = false;
                    await wait(300); // ç­‰å¾…æ¶ˆå¤±
                    
                    gameState = 'idle';
                    
                    // è‡ªåŠ¨å‰è¿›åˆ°ä¸‹ä¸€å¥
                    await runNextStep();

                } else if (line.type === 'scene') {
                    dialogueBox.classList.remove('show');
                    sceneTitle.textContent = line.text;
                    sceneTitle.classList.add('show');
                    sceneTransitionText.textContent = line.text;

                    gameState = 'scene';
                    sceneTransition.classList.add('show');
                    sceneTransitionText.style.transform = 'translateX(0)';
                    
                    clearTimeout(sceneTimeout);
                    sceneTimeout = setTimeout(runNextStep, 2500); // 2.5ç§’åè‡ªåŠ¨å‰è¿›
                    
                    // V20.0 ä¿®å¤: ä¸åšä»»ä½• awaitï¼Œç«‹å³è¿”å›
                    // è®© runNextStep ç»“æŸã€‚ç­‰å¾…ä¸‹ä¸€æ¬¡ç‚¹å‡»æˆ–
                    // sceneTimeout è§¦å‘ã€‚

                } else {
                    // æ—ç™½æˆ–å¯¹è¯
                    dialogueBox.classList.add('show');
                    sceneTitle.classList.add('show');
                    if (line.type === 'narration') {
                        characterName.textContent = '';
                        dialogueBox.classList.add('name-hidden'); // V20.5 æ·»åŠ 
                        updateLog('æ—ç™½', line.text);
                    } else {
                        characterName.textContent = line.character;
                        dialogueBox.classList.remove('name-hidden'); // V20.5 æ·»åŠ 
                        updateLog(line.character, line.text);
                    }
                    
                    await startTypewriter(line.text); // ç­‰å¾…æ‰“å­—å®Œæˆ
                }
            }

            // ----------------------------------------
            // 5. åŠ¨ç”» & æ‰“å­— (V14.1)
            // ----------------------------------------

            // V14 æ–°å¢ï¼šè‰ºæœ¯å­—åŠ¨ç”»
            function animateSectionTitle(main, sub) {
                sectionTitleMain.innerHTML = '';
                sectionTitleSub.textContent = sub;
                
                main.split('').forEach((char, index) => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char; // å¤„ç†ç©ºæ ¼
                    span.style.animationDelay = `${index * 0.05}s`;
                    sectionTitleMain.appendChild(span);
                });
                
                sectionTitle.classList.add('show');
            }

            function startTypewriter(text) {
                return new Promise(resolve => {
                    gameState = 'typing';
                    // isAnimationLocked = true; // V14.1 ç§»é™¤ï¼šæ‰“å­—æ˜¯å¯ä¸­æ–­çš„
                    dialogueText.classList.remove('completed'); // V14.1 æ·»åŠ ï¼šæ˜¾ç¤ºå…‰æ ‡
                    dialogueText.textContent = '';
                    let index = 0;
                    const typeSpeed = skipMode ? 0 : 40;

                    function type() {
                        if (index < text.length) {
                            dialogueText.textContent += text.charAt(index);
                            index++;
                            typeTimeout = setTimeout(type, typeSpeed);
                        } else {
                            finishTyping(resolve);
                        }
                    }
                    type();
                });
            }

            function skipTyping() {
                if (gameState !== 'typing') return;
                clearTimeout(typeTimeout);
                const line = storyData[currentLine - 1];
                dialogueText.textContent = line.text;
                // isAnimationLocked = false; // V14.1 ç§»é™¤
                gameState = 'idle';
                dialogueText.classList.add('completed');
            }

            function finishTyping(resolve) {
                // isAnimationLocked = false; // V14.1 ç§»é™¤
                gameState = 'idle';
                dialogueText.classList.add('completed');
                resolve();
            }

            // ----------------------------------------
            // 6. æ ¸å¿ƒç‚¹å‡»å¤„ç† (V14)
            // ----------------------------------------
            function handleUserClick() {
                if (autoMode) {
                    stopAuto();
                    return; 
                }
                if (skipMode) {
                    stopSkip();
                    return; 
                }
                runNextStep();
            }
            
            clickArea.addEventListener('click', handleUserClick);
            sectionTitle.addEventListener('click', handleUserClick);
            sceneTransition.addEventListener('click', handleUserClick);
            
            // V19.0 æ•…äº‹ç»“æŸæŒ‰é’®
            storyEndBtn.addEventListener('click', () => {
                storyEndScreen.style.display = 'none';
                showTitleScreen();
            });

            // ----------------------------------------
            // 7. Auto / Skip (V14 æ ¸å¿ƒé‡æ„)
            // ----------------------------------------
            
            // V14 æ–°å¢ï¼šç»Ÿä¸€çš„å¾ªç¯è§¦å‘å™¨
            function triggerAutoOrSkip() {
                if (autoMode) {
                    // å¦‚æœæ­£åœ¨æ’­ç« èŠ‚åŠ¨ç”»ï¼Œç­‰å®ƒ
                    if (isAnimationLocked || gameState !== 'idle') return;
                    // å¦åˆ™ï¼ŒæŒ‰é€Ÿåº¦ç­‰
                    autoTimeout = setTimeout(runNextStep, currentAutoSpeed);
                } else if (skipMode) {
                    // å¦‚æœæ­£åœ¨æ’­ç« èŠ‚åŠ¨ç”»ï¼Œç­‰å®ƒ
                    if (isAnimationLocked || gameState === 'section') return;
                    // å¦åˆ™ï¼ŒæŒ‰é€Ÿåº¦ç­‰
                    skipTimeout = setTimeout(runNextStep, currentSkipSpeed);
                }
            }
            
            function startAuto(speed) {
                stopSkip();
                autoMode = true;
                currentAutoSpeed = autoSpeeds[speed];
                autoBtn.classList.add('active');
                autoBtn.textContent = `Auto ${autoSpeedLabels[speed]}`;
                runNextStep(); // å¯åŠ¨
            }

            function stopAuto() {
                clearTimeout(autoTimeout);
                clearTimeout(sceneTimeout); // V14.8
                if (autoMode) {
                    autoMode = false;
                    autoBtn.classList.remove('active');
                    autoBtn.textContent = `Auto`;
                }
            }

            function startSkip(speed) {
                stopAuto();
                skipMode = true;
                currentSkipSpeed = skipSpeeds[speed];
                skipBtn.classList.add('active');
                skipBtn.textContent = `å¿«è¿› ${skipSpeedLabels[speed]}`;
                runNextStep(); // å¯åŠ¨
            }
            
            function stopSkip() {
                clearTimeout(skipTimeout);
                clearTimeout(sceneTimeout); // V14.8
                if (skipMode) {
                    skipMode = false;
                    skipBtn.classList.remove('active');
                    skipBtn.textContent = `å¿«è¿›`;
                }
            }
            
            // ----------------------------------------
            // 8. å¼¹çª—ç®¡ç† (V20.1 çŠ¶æ€æœºä¿®å¤)
            // ----------------------------------------
            
            function openModal(modal) {
                // V15.0 æ ‡é¢˜åœ¨æ—¶ï¼Œæ¸¸æˆä¹Ÿåœ¨ modal æ¨¡å¼
                if (titleScreen.style.display === 'flex') {
                    gameState = 'modal';
                    // V20.1 ä¿®å¤ï¼šæ ‡é¢˜åœ¨æ—¶ï¼Œä¹Ÿè¦åœæ­¢ auto/skip
                    stopAuto(); stopSkip();
                } 
                // V20.1 ä¿®å¤ï¼šä»»ä½•æ—¶å€™æ‰“å¼€å¼¹çª—ï¼Œéƒ½åº”è¯¥æš‚åœæ¸¸æˆ
                else if (gameContainer.style.display === 'flex' && gameState !== 'modal') {
                    // V20.1 ä¿®å¤ï¼šåªæœ‰åœ¨æ¸¸æˆå†…æ‰“å¼€å¼¹çª—æ‰éœ€è¦åœæ­¢
                    stopAuto(); stopSkip();
                    gameState = 'modal';
                }
                
                // V20.1 ä¿®å¤ï¼šæ‰“å¼€èœå•æ—¶éšè—æŒ‰é’®
                if (modal.id === 'menu-modal') {
                    menuBtn.style.display = 'none';
                }
            
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.add('show');
                    if (modal.id === 'menu-modal') {
                        menuPanel.style.transform = 'translateX(0)';
                    }
                }, 10); 
            }
            
            function closeModal(modal) {
                modal.classList.remove('show');
                if (modal.id === 'menu-modal') {
                    menuPanel.style.transform = 'translateX(100%)';
                }
                setTimeout(() => {
                    modal.style.display = 'none';
                    
                    // V20.1 ä¿®å¤ï¼šå…³é—­èœå•æ—¶æ˜¾ç¤ºæŒ‰é’®
                    if (modal.id === 'menu-modal') {
                        menuBtn.style.display = 'flex';
                    }
                
                    if (!document.querySelector('.modal-backdrop.show')) {
                        // V15.0 æ£€æŸ¥æ ‡é¢˜æ˜¯å¦è¿˜åœ¨
                        if (titleScreen.style.display !== 'flex') {
                            // V20.1 ä¿®å¤ï¼š
                            // åªæœ‰å½“ gameState æ˜¯ 'modal' æ—¶æ‰å°†å…¶é‡ç½®ä¸º 'idle'
                            // å¦‚æœ gameState æ˜¯ 'scene' æˆ– 'section' (ç”± jumpToLine è®¾ç½®), 
                            // åˆ™ä¿æŒä¸å˜ã€‚
                            if (gameState === 'modal') {
                                 gameState = 'idle';
                            }
                        }
                    }
                }, 300); 
            }
            
            allCloseBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = document.getElementById(btn.dataset.modalId);
                    closeModal(modal);
                });
            });

            menuModal.addEventListener('click', (e) => {
                if (e.target === menuModal) {
                    closeModal(menuModal);
                }
            });

            menuBtn.addEventListener('click', () => {
                // V20.1 ä¿®å¤ï¼šåœæ­¢ auto/skip çš„é€»è¾‘ç§»å…¥ openModal
                updateStoryList();
                openModal(menuModal);
            });
            
            // V16.0 æ ‡é¢˜ç”»é¢æŒ‰é’®
            titleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showTitleScreen();
            });
            titleContinueBtn.addEventListener('click', () => {
                const lastName = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                const lastLine = parseInt(localStorage.getItem(LAST_POS_PREFIX + lastName) || 0, 10);
                startGame(lastName, lastLine);
            });
            titleStartBtn.addEventListener('click', () => {
                const lastName = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                if (confirm(`ç¡®å®šè¦ä»å¤´å¼€å§‹é˜…è¯»ã€Š${lastName}ã€‹å—ï¼Ÿ`)) {
                    startGame(lastName, 0);
                }
            });
            titleLoadBtn.addEventListener('click', () => {
                // V16.0 ä¿®å¤ï¼šä¼ å…¥æ­£ç¡®çš„æ•…äº‹å
                const lastStory = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                openSaveLoadModal('load', lastStory);
            });
            titleStoryListBtn.addEventListener('click', () => {
                updateStoryList();
                openModal(menuModal);
            });
            titleSettingsBtn.addEventListener('click', () => {
                openModal(settingsModal);
            });
            
            // é€Ÿåº¦å¼¹çª—
            function openSpeedModal(mode) {
                currentSpeedSetMode = mode;
                speedOptions.innerHTML = ''; // æ¸…ç©º
                if (mode === 'auto') {
                    speedModalTitle.textContent = 'è®¾ç½® Auto é€Ÿåº¦';
                    for (const speedKey in autoSpeeds) {
                        const btn = document.createElement('button');
                        btn.dataset.speed = speedKey;
                        btn.textContent = autoSpeedLabels[speedKey];
                        speedOptions.appendChild(btn);
                    }
                } else {
                    speedModalTitle.textContent = 'è®¾ç½®å¿«è¿›é€Ÿåº¦';
                    for (const speedKey in skipSpeeds) {
                        const btn = document.createElement('button');
                        btn.dataset.speed = speedKey;
                        btn.textContent = skipSpeedLabels[speedKey];
                        speedOptions.appendChild(btn);
                    }
                }
                openModal(speedModal);
            }
            autoBtn.addEventListener('click', (e) => { e.stopPropagation(); openSpeedModal('auto'); });
            skipBtn.addEventListener('click', (e) => { e.stopPropagation(); openSpeedModal('skip'); });
            speedCancelBtn.addEventListener('click', () => closeModal(speedModal));
            
            speedOptions.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const speed = e.target.dataset.speed;
                    const mode = currentSpeedSetMode;
                    closeModal(speedModal);
                    closeModal(menuModal);
                    setTimeout(() => {
                        if (mode === 'auto') {
                            startAuto(speed);
                        } else {
                            startSkip(speed);
                        }
                    }, 310);
                }
            });

            // ----------------------------------------
            // 9. å‰§æƒ…å¯¼å…¥ä¸ç®¡ç† (V18.0 ä¿®å¤)
            // ----------------------------------------
            
            const storyDB = {
                getAll: () => {
                    let db = localStorage.getItem(STORY_DB_KEY);
                    try { db = JSON.parse(db); if (!db) db = {}; } catch (e) { db = {}; }
                    
                    // V18.0 ä¿®å¤ï¼šä»…å½“æ•°æ®åº“*å®Œå…¨*ä¸ºç©ºæ—¶æ‰æ·»åŠ é»˜è®¤æ•…äº‹
                    if (Object.keys(db).length === 0) {
                        db[DEFAULT_STORY_NAME] = DEFAULT_STORY_TEXT;
                        storyDB.saveAll(db);
                    }
                    return db;
                },
                saveAll: (db) => { localStorage.setItem(STORY_DB_KEY, JSON.stringify(db)); },
                saveStory: (name, text) => {
                    const db = storyDB.getAll();
                    db[name] = text;
                    storyDB.saveAll(db);
                }
            };
            
            function parseStoryText(text) {
                const lines = text.split('\n');
                const data = [];
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('# ')) {
                        // V14 æŠ“å–å‰¯æ ‡é¢˜
                        const parts = trimmedLine.substring(2).split('|');
                        data.push({ type: 'section', main: parts[0].trim(), sub: (parts[1] || '').trim() });
                    } else if (trimmedLine.startsWith('## ')) {
                        data.push({ type: 'scene', text: trimmedLine.substring(3) });
                    } else {
                        const parts = trimmedLine.split(': ');
                        if (parts.length === 2) {
                            const char = parts[0];
                            const text = parts[1];
                            if (char === 'æ—ç™½') {
                                data.push({ type: 'narration', text: text });
                            } else {
                                data.push({ character: char, text: text });
                            }
                        }
                    }
                }
                return data;
            }

            // V11 é€»è¾‘ (V20.4 æ›´æ–°ï¼šæ·»åŠ ç¼–è¾‘æŒ‰é’®)
            function updateStoryList() {
                storyList.innerHTML = '';
                const db = storyDB.getAll();
                const lastStory = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                
                for (const name in db) {
                    const item = document.createElement('div');
                    item.className = 'story-item';
                    item.dataset.storyName = name; // å­˜åå­—
                    
                    const nameEl = document.createElement('div');
                    nameEl.className = 'story-name';
                    nameEl.textContent = name;
                    item.appendChild(nameEl);
                    
                    // V20.4 æ·»åŠ ç¼–è¾‘æŒ‰é’®
                    const editBtn = document.createElement('span');
                    editBtn.className = 'story-edit-btn';
                    editBtn.textContent = 'ç¼–è¾‘';
                    item.appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'story-delete-btn';
                    deleteBtn.textContent = 'åˆ é™¤';
                    item.appendChild(deleteBtn);

                    // V16.0 ä¿®å¤ï¼šé«˜äº®å½“å‰*å·²åŠ è½½*çš„æ•…äº‹
                    if (name === lastStory) {
                        item.classList.add('active');
                        
                        // V16.0 ä»…åœ¨æ¸¸æˆå†…æ‰“å¼€æ—¶æ‰åŠ è½½ç« èŠ‚
                        if (gameContainer.style.display === 'flex') {
                            const chapterList = document.createElement('div');
                            chapterList.className = 'chapter-list';
                            
                            storyData.forEach((line, index) => {
                                if (line.type === 'section' || line.type === 'scene') {
                                    const chapterItem = document.createElement('div');
                                    chapterItem.className = 'chapter-item';
                                    chapterItem.classList.add(line.type); // 'section' or 'scene'
                                    chapterItem.textContent = line.main || line.text;
                                    chapterItem.dataset.lineIndex = index;
                                    chapterList.appendChild(chapterItem);
                                }
                            });
                            item.appendChild(chapterList);
                        }
                    }
                    storyList.appendChild(item);
                }
            }

            // V11 é€»è¾‘ (V20.4 æ›´æ–°ï¼šæ·»åŠ ç¼–è¾‘äº‹ä»¶)
            storyList.addEventListener('click', (e) => {
                const target = e.target;
                const storyItem = target.closest('.story-item');
                if (!storyItem) return;
                const name = storyItem.dataset.storyName;
                
                if (target.classList.contains('story-delete-btn')) {
                    deleteStory(name);
                    return;
                }
                
                // V20.4 å¤„ç†ç¼–è¾‘æŒ‰é’®
                if (target.classList.contains('story-edit-btn')) {
                    const db = storyDB.getAll();
                    const storyText = db[name];
                    if (storyText) {
                        editDbStoryTextarea.value = storyText;
                        editDbStoryModal.dataset.storyName = name; // å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ•…äº‹å
                        openModal(editDbStoryModal);
                    } else {
                        alert('æ‰¾ä¸åˆ°æ•…äº‹æ•°æ®ï¼');
                    }
                    return;
                }
                
                if (target.classList.contains('chapter-item')) {
                    const index = parseInt(target.dataset.lineIndex, 10);
                    handleChapterJump(index);
                    return;
                }
                
                // V16.0 ä¿®å¤ï¼šå±•å¼€é€»è¾‘
                const lastStory = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                if (name === lastStory && gameContainer.style.display === 'flex') {
                    storyItem.classList.toggle('expanded');
                } else if (name !== lastStory) {
                    if (confirm(`è¦åˆ‡æ¢åˆ°æ•…äº‹ã€Š${name}ã€‹å—ï¼Ÿ\nï¼ˆå°†ä»å¤´å¼€å§‹ï¼‰`)) {
                        closeModal(menuModal);
                        // V15.0 åˆ‡æ¢æ•…äº‹
                        startGame(name, 0);
                    }
                }
            });

            // V12 ä¿®å¤ï¼šå†å²è®°å½•
            function handleChapterJump(lineIndex) {
                if (confirm(`ç¡®å®šè¦è·³è½¬åˆ°è¿™ä¸ªç« èŠ‚å—ï¼Ÿ\nå½“å‰è¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚`)) {
                    jumpToLine(lineIndex);
                    closeModal(menuModal);
                }
            }

            // V15.0 é€»è¾‘é‡æ„
            function jumpToLine(lineIndex, fromSave = false) {
                // V20.1 ä¿®å¤ï¼šè·³è½¬æ—¶ï¼Œç«‹å³è„±ç¦» modal çŠ¶æ€ï¼Œå…è®¸ runNextStep
                gameState = 'idle';
                
                // é‡ç½®
                logHistory = [];
                logContent.innerHTML = '';
                sectionTitle.classList.remove('show');
                dialogueBox.classList.remove('show');
                sceneTitle.classList.remove('show');
                sceneTransition.classList.remove('show', 'slide-out');
                storyEndScreen.style.display = 'none'; // V19.0 éšè—
                stopAuto(); stopSkip();
                clearTimeout(sceneTimeout);

                // V14.5 ä¿®å¤ï¼šé‡å»ºå†å²å’ŒæŸ¥æ‰¾å½“å‰åœºæ™¯
                let currentSceneText = "ç‚¹å‡»å¼€å§‹"; // é»˜è®¤å€¼
                if (fromSave) {
                    for (let i = 0; i< lineIndex; i++) {
                        const line = storyData[i];
                        if (line.type === 'scene') {
                            currentSceneText = line.text; // æ‰¾åˆ°å­˜æ¡£ç‚¹ä¹‹å‰çš„æœ€åä¸€ä¸ªåœºæ™¯
                        }
                        if (line.type === 'narration') {
                            updateLog('æ—ç™½', line.text);
                        } else if (!line.type || (line.type && line.type !== 'section' && line.type !== 'scene')) {
                            updateLog(line.character, line.text);
                        }
                    }
                }
                
                sceneTitle.textContent = currentSceneText;
                
                currentLine = lineIndex;
                
                // V15.0 ä¿®å¤: å¤„ç† lineIndex = 0 çš„æƒ…å†µ
                if (currentLine === 0) {
                    dialogueBox.classList.add('show');
                    sceneTitle.classList.add('show');
                    sceneTitle.textContent = "ç‚¹å‡»å¼€å§‹";
                    characterName.textContent = currentStoryName;
                    dialogueBox.classList.remove('name-hidden'); // V20.5 ç¡®ä¿é‡ç½®
                    dialogueText.textContent = "ç‚¹å‡»å±å¹•å¼€å§‹é˜…è¯»æ•…äº‹...";
                    gameState = 'idle';
                } else {
                    gameState = 'idle';
                    runNextStep();
                }
            }
            
            function deleteStory(name) {
                const db = storyDB.getAll();
                // V18.0 ä¿®å¤: æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªæ•…äº‹
                if (name === DEFAULT_STORY_NAME && Object.keys(db).length === 1) {
                     alert('è¿™æ˜¯æœ€åä¸€ä¸ªæ•…äº‹ï¼Œæ— æ³•åˆ é™¤ï¼');
                     return;
                }
                
                // V16.0 ä¿®å¤ï¼šä½¿ç”¨ lastStory
                const lastStory = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                if (name === lastStory) {
                    alert('ä¸èƒ½åˆ é™¤æ­£åœ¨åŠ è½½çš„æ•…äº‹ï¼\nè¯·å…ˆåˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ•…äº‹ã€‚');
                    return;
                }
                if (confirm(`ç¡®å®šè¦åˆ é™¤æ•…äº‹ã€Š${name}ã€‹å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                    delete db[name];
                    storyDB.saveAll(db);
                    localStorage.removeItem(`${SAVE_KEY_PREFIX}${name}`);
                    localStorage.removeItem(LAST_POS_PREFIX + name); // V15.0 åˆ é™¤è¿›åº¦
                    alert('åˆ é™¤æˆåŠŸï¼');
                    updateStoryList();
                }
            }
            
            importStoryBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    let name = file.name.replace('.txt', '');
                    if (!name) name = "æœªå‘½åæ•…äº‹";
                    const db = storyDB.getAll();
                    if (db[name]) {
                        if (!confirm(`æ•…äº‹ã€Š${name}ã€‹å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) {
                            importFileInput.value = '';
                            return;
                        }
                    }
                    storyDB.saveStory(name, text);
                    importFileInput.value = '';
                    alert(`ã€Š${name}ã€‹å¯¼å…¥æˆåŠŸï¼`);
                    updateStoryList();
                };
                reader.readAsText(file);
            });

            // ----------------------------------------
            // 10. å†å²è®°å½• (V14.7 æ»šåŠ¨ä¿®å¤)
            // ----------------------------------------
            function updateLog(character, text) {
                logHistory.push({ character, text });
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `<div class="log-character">${character}</div><div class="log-text">${text}</div>`;
                logContent.appendChild(entry);
                logContent.scrollTop = logContent.scrollHeight;
            }
            
            logBtn.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                openModal(logModal); 
                logContent.scrollTop = logContent.scrollHeight;
            });
            
            // ----------------------------------------
            // 11. å­˜è¯»æ¡£ (V16.0 æ•…äº‹åä¿®å¤)
            // ----------------------------------------
            
            // V16.0 ä¿®å¤ï¼šä¼ å…¥æ•…äº‹å
            const getSaveStoreName = (name) => `${SAVE_KEY_PREFIX}${name}`;
            
            function getSaveData(name) {
                let data = localStorage.getItem(getSaveStoreName(name));
                try { data = JSON.parse(data); if (!Array.isArray(data)) data = []; }
                catch (e) { data = []; }
                return data;
            }
            function setSaveData(name, data) {
                localStorage.setItem(getSaveStoreName(name), JSON.stringify(data));
            }
            
            function openSaveLoadModal(mode, storyName) {
                currentSaveLoadMode = mode;
                saveLoadTitle.textContent = mode === 'save' ? 'å­˜æ¡£' : 'è¯»æ¡£';
                saveLoadContent.innerHTML = '';
                
                const saveData = getSaveData(storyName); 

                for (let i = 0; i < TOTAL_SAVE_SLOTS; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'save-slot';
                    slot.dataset.slotIndex = i;
                    const slotData = saveData[i];
                    if (slotData) {
                        slot.innerHTML = `
                            <div class="slot-header">
                                <span class="slot-header-left">${slotData.customName || `æ¡£ä½ ${i + 1}`}</span>
                                <span class="slot-header-right">
                                    <span class="slot-time">${slotData.time}</span>
                                    <span class="slot-rename-btn" data-slot-index="${i}">âœï¸</span>
                                </span>
                            </div>
                            <div class="slot-chapter">${slotData.chapter}</div>
                            <div class="slot-line">${slotData.line}</div>`;
                    } else {
                        slot.innerHTML = `æ¡£ä½ ${i + 1}<br>ï¼ˆç©ºï¼‰`;
                        slot.classList.add('empty');
                    }
                    // V16.0 ä¿®å¤ï¼šä¼ é€’ storyName
                    slot.addEventListener('click', () => handleSlotClick(i, storyName));
                    saveLoadContent.appendChild(slot);
                }

                saveLoadContent.querySelectorAll('.slot-rename-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(e.currentTarget.dataset.slotIndex, 10);
                        // V16.0 ä¿®å¤ï¼šä¼ é€’ storyName
                        renameSaveSlot(index, storyName);
                    });
                });

                openModal(saveLoadModal);
            }

            // V16.0 ä¿®å¤ï¼šä¼ é€’ storyName
            function handleSlotClick(index, storyName) {
                if (currentSaveLoadMode === 'save') {
                    saveGame(index); // Save æ€»æ˜¯ä¿å­˜ *å½“å‰* æ¸¸æˆ (currentStoryName)
                } else {
                    loadGame(index, storyName); // Load éœ€è¦æŒ‡å®šæ•…äº‹
                }
            }

            // V16.0 ä¿®å¤ï¼šä¼ é€’ storyName
            function renameSaveSlot(index, storyName) {
                const saveData = getSaveData(storyName);
                const slotData = saveData[index];
                if (!slotData) {
                    alert('ç©ºæ¡£ä½æ— æ³•é‡å‘½åï¼');
                    return;
                }
                const currentName = slotData.customName || `æ¡£ä½ ${index + 1}`;
                const newName = prompt(`è¯·è¾“å…¥æ–°çš„å­˜æ¡£åç§°ï¼š`, currentName);
                if (newName && newName.trim() !== '') {
                    slotData.customName = newName.trim();
                    setSaveData(storyName, saveData);
                    alert('é‡å‘½åæˆåŠŸï¼');
                    openSaveLoadModal(currentSaveLoadMode, storyName);
                }
            }

            function saveGame(index) {
                if (currentLine === 0 && (gameState === 'idle' || !storyData[currentLine])) { alert('æ•…äº‹è¿˜æ²¡å¼€å§‹ï¼Œæ— æ³•å­˜æ¡£ï¼'); return; }
                const lineIndex = currentLine - 1;
                const line = storyData[lineIndex];
                if (!line) { alert('å­˜æ¡£æ•°æ®å¼‚å¸¸ï¼'); return; } 
                
                let chapter = 'åºç« ';
                for (let i = lineIndex; i >= 0; i--) {
                    if (storyData[i].type === 'section') {
                        chapter = storyData[i].main;
                        break;
                    }
                }
                
                const saveData = getSaveData(currentStoryName);
                
                if (saveData[index]) {
                    const displayName = saveData[index].customName || `æ¡£ä½ ${index + 1}`;
                    if (!confirm(`ç¡®å®šè¦è¦†ç›– ${displayName} å—ï¼Ÿ\nï¼ˆ${saveData[index].chapter}ï¼‰`)) {
                        return;
                    }
                }
                
                const existingName = (saveData[index] && saveData[index].customName) ? saveData[index].customName : null;

                saveData[index] = {
                    time: new Date().toLocaleString('zh-CN', { hour12: false }),
                    chapter: chapter,
                    line: line.text || (line.type === 'narration' ? "ï¼ˆæ—ç™½ï¼‰" : (line.type === 'scene' ? "ï¼ˆåœºæ™¯åˆ‡æ¢ï¼‰" : "ï¼ˆç« èŠ‚æ ‡é¢˜ï¼‰")),
                    data: lineIndex,
                    customName: existingName
                };
                setSaveData(currentStoryName, saveData);
                alert(`æ¡£ä½ ${index + 1} å­˜æ¡£æˆåŠŸï¼`);
                closeModal(saveLoadModal);
            }

            // V16.0 ä¿®å¤ï¼šä¼ é€’ storyName
            function loadGame(index, storyName) {
                const saveData = getSaveData(storyName);
                const slotData = saveData[index];
                if (!slotData) { alert('è¿™æ˜¯ä¸€ä¸ªç©ºæ¡£ä½ï¼'); return; }
                
                const displayName = slotData.customName || `æ¡£ä½ ${index + 1}`;
                if (!confirm(`è¦è¯»å– ${displayName} å—ï¼Ÿ\nï¼ˆ${slotData.chapter}ï¼‰`)) { return; }
                
                alert('è¯»æ¡£å®Œæˆï¼');
                closeModal(saveLoadModal);
                closeModal(menuModal);
                
                // V15.0 è¯»æ¡£å¯åŠ¨
                startGame(storyName, slotData.data);
            }
            // V16.0 ä¿®å¤ï¼šä¼ å…¥æ­£ç¡®çš„æ•…äº‹å
            saveBtn.addEventListener('click', (e) => { e.stopPropagation(); openSaveLoadModal('save', currentStoryName); });
            loadBtn.addEventListener('click', (e) => { e.stopPropagation(); openSaveLoadModal('load', currentStoryName); });

            // ----------------------------------------
            // 12. V18.0 AI è½¬æ¢åŠŸèƒ½ (V20.3 ä¿®å¤)
            // ----------------------------------------
            convertStartBtn.addEventListener('click', handleStoryConversion);
            copyPromptBtn.addEventListener('click', () => {
                try {
                    navigator.clipboard.writeText(AI_CONVERT_PROMPT);
                    alert('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } catch (e) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                }
            });

            async function handleStoryConversion() {
                const file = convertFileInput.files[0];
                if (!file) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª .txt, .md, æˆ– .rtf æ–‡ä»¶ï¼');
                    return;
                }
                
                // V18.0 è­¦å‘Š
                if (!file.name.endsWith('.txt') && !file.name.endsWith('.md') && !file.name.endsWith('.rtf')) {
                    if (!confirm("è¿™ä¼¼ä¹ä¸æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ã€‚è½¬æ¢ç»“æœå¯èƒ½ä¸ä½³ï¼Œè¦ç»§ç»­å—ï¼Ÿ")) {
                        convertFileInput.value = '';
                        return;
                    }
                }
                
                loadingOverlay.style.display = 'flex';
                
                const originalText = await file.text();
                
                try {
                    const resultText = await fetchAIApi(originalText, AI_CONVERT_PROMPT);
                    convertedStoryText = resultText;
                    
                    convertFileInput.value = ''; 
                    loadingOverlay.style.display = 'none';
                    openModal(convertResultModal);
                    
                } catch (error) {
                    console.error('AI è½¬æ¢å¤±è´¥:', error);
                    alert('è½¬æ¢å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œæˆ– API å¯†é’¥ã€‚\n' + error.message);
                    loadingOverlay.style.display = 'none';
                }
            }

            async function fetchAIApi(text, prompt) {
                // V20.2 ä¿®å¤ï¼šæ·»åŠ  /v1/chat/completions ç«¯ç‚¹
                const API_URL = "https://gcli.ggchan.dev/v1/chat/completions";
                const API_KEY = "gg-gcli-xCpc8VNdE1kRE34dY-VpTMMQXI_CrpcjwNqCvRHed9A";
                const model = "gemini-2.5-pro-preview-06-05";

                const body = JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: prompt },
                        { role: "user", content: text }
                    ]
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: body
                });

                if (!response.ok) {
                    throw new Error(`API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }
                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('API è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚');
                }
            }

            convertDownloadBtn.addEventListener('click', () => {
                const blob = new Blob([convertedStoryText], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `[å·²è½¬æ¢] ${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                closeModal(convertResultModal);
            });
            
            convertImportBtn.addEventListener('click', () => {
                let name = prompt("è¯·è¾“å…¥æ–°æ•…äº‹çš„åç§°ï¼š", "è½¬æ¢åçš„æ•…äº‹");
                if (name && name.trim() !== '') {
                    storyDB.saveStory(name, convertedStoryText);
                    alert('å¯¼å…¥æˆåŠŸï¼');
                    // updateStoryList(); // V15.0 æ­¤æ—¶èœå•å¯èƒ½æœªæ‰“å¼€
                }
                closeModal(convertResultModal);
            });
            
            // V20.3 è½¬æ¢åç¼–è¾‘ (AI)
            convertEditBtn.addEventListener('click', () => {
                editStoryTextarea.value = convertedStoryText;
                closeModal(convertResultModal);
                openModal(editStoryModal);
            });
            
            editStorySaveBtn.addEventListener('click', () => {
                convertedStoryText = editStoryTextarea.value;
                closeModal(editStoryModal);
                alert('ä¿®æ”¹å·²ä¿å­˜ï¼');
                openModal(convertResultModal); // é‡æ–°æ‰“å¼€é€‰æ‹©å¯¼å…¥æˆ–ä¸‹è½½
            });
            
            editStoryCancelBtn.addEventListener('click', () => {
                closeModal(editStoryModal);
                openModal(convertResultModal); // å–æ¶ˆç¼–è¾‘ï¼Œè¿”å›
            });
            
            // V20.4 æ•°æ®åº“æ•…äº‹ç¼–è¾‘å¼¹çª—çš„äº‹ä»¶
            editDbStorySaveBtn.addEventListener('click', () => {
                const storyName = editDbStoryModal.dataset.storyName;
                if (!storyName) return;
                
                const newText = editDbStoryTextarea.value;
                storyDB.saveStory(storyName, newText);
                
                closeModal(editDbStoryModal);
                updateStoryList(); // åˆ·æ–°èœå•é‡Œçš„åˆ—è¡¨
                
                // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†å½“å‰çš„æ•…äº‹
                if (storyName === currentStoryName && gameContainer.style.display === 'flex') {
                    alert('ä½ ä¿®æ”¹äº†å½“å‰æ­£åœ¨é˜…è¯»çš„æ•…äº‹ï¼Œé˜…è¯»å™¨å°†è¿”å›æ ‡é¢˜ç”»é¢ä»¥é‡æ–°åŠ è½½ã€‚');
                    showTitleScreen();
                } else {
                    alert('ä¿å­˜æˆåŠŸï¼');
                }
            });
            
            editDbStoryCancelBtn.addEventListener('click', () => {
                closeModal(editDbStoryModal);
            });
            
            
            // ----------------------------------------
            // 13. V17.0 å­—ä½“ç®¡ç† (CSS è§£æ)
            // ----------------------------------------
            
            function loadFontsFromStorage() {
                const fonts = JSON.parse(localStorage.getItem(FONT_DB_KEY) || '[]');
                
                let optionsHTML = `<option value="${DEFAULT_FONT_VALUE}">é»˜è®¤ç³»ç»Ÿå­—ä½“</option>`;
                let importCSS = '';

                fonts.forEach(font => {
                    // V17.0 ä¿®å¤: å¿…é¡»è½¬ä¹‰ value å±æ€§ä¸­çš„å¼•å·
                    const escapedFamily = font.family.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    optionsHTML += `<option value="${escapedFamily}">${font.name}</option>`;
                    importCSS += `@import url('${font.url}');\n`;
                });
                
                fontSelect.innerHTML = optionsHTML; // ä¸€æ¬¡æ€§è®¾ç½®
                fontImportStyles.textContent = importCSS;
            }

            function applyFont(fontFamily) {
                // V17.0 ä¿®å¤: æ¢å¤é»˜è®¤
                if (fontFamily === DEFAULT_FONT_VALUE || fontFamily === '' || !fontFamily) {
                    document.body.style.removeProperty('font-family');
                    localStorage.setItem(LAST_FONT_KEY, DEFAULT_FONT_VALUE);
                } else {
                    document.body.style.fontFamily = fontFamily;
                    localStorage.setItem(LAST_FONT_KEY, fontFamily);
                }
            }

            function applyLastFont() {
                const lastFont = localStorage.getItem(LAST_FONT_KEY) || DEFAULT_FONT_VALUE;
                applyFont(lastFont);
                fontSelect.value = lastFont;
            }

            fontSaveBtn.addEventListener('click', () => {
                const name = fontNameInput.value.trim();
                const cssBlock = fontCssInput.value.trim();
                
                if (!name || !cssBlock) {
                    alert('è¯·å¡«å†™â€œå­—ä½“æ˜µç§°â€å’Œâ€œCSS ä»£ç â€ï¼');
                    return;
                }
                
                let url = '';
                let family = '';

                // V17.0 ä½¿ç”¨ RegEx è§£æ
                try {
                    // åŒ¹é… @import url("...") æˆ– @import url('...')
                    const urlMatch = cssBlock.match(/@import\s+url\((['"])(.*?)\1\);/);
                    if (urlMatch && urlMatch[2]) {
                        url = urlMatch[2];
                    } else {
                        throw new Error('æœªæ‰¾åˆ° @import url("...");');
                    }
                    
                    // åŒ¹é… font-family: ...; (å¯èƒ½åœ¨ body{} ä¸­ä¹Ÿå¯èƒ½ä¸åœ¨)
                    const familyMatch = cssBlock.match(/font-family:\s*([^;]+);/);
                    if (familyMatch && familyMatch[1]) {
                        family = familyMatch[1].trim();
                    } else {
                        throw new Error("æœªæ‰¾åˆ° font-family: ...; è§„åˆ™ã€‚");
                    }
                } catch (e) {
                    alert('CSS è§£æå¤±è´¥ï¼š\n' + e.message + '\n\nè¯·ç¡®ä¿ç²˜è´´äº†å®Œæ•´çš„ @import å’Œ font-family ä»£ç ã€‚');
                    return;
                }

                const fonts = JSON.parse(localStorage.getItem(FONT_DB_KEY) || '[]');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (fonts.find(f => f.name === name || f.family === family)) {
                    alert('å·²å­˜åœ¨åŒåæˆ–åŒ font-family çš„å­—ä½“ï¼');
                    return;
                }

                fonts.push({ name, url, family });
                localStorage.setItem(FONT_DB_KEY, JSON.stringify(fonts));
                
                loadFontsFromStorage(); // é‡æ–°åŠ è½½ @import å’Œ select
                applyFont(family); // åº”ç”¨æ–°å­—ä½“
                fontSelect.value = family; // é€‰ä¸­æ–°å­—ä½“
                
                fontNameInput.value = '';
                fontCssInput.value = '';
                
                alert('å­—ä½“ä¿å­˜æˆåŠŸï¼');
            });

            fontSelect.addEventListener('change', (e) => {
                applyFont(e.target.value);
            });
            
            fontDefaultBtn.addEventListener('click', () => {
                applyFont(DEFAULT_FONT_VALUE);
                fontSelect.value = DEFAULT_FONT_VALUE;
            });
            
            fontDeleteBtn.addEventListener('click', () => {
                const selectedFontFamily = fontSelect.value;
                if (selectedFontFamily === DEFAULT_FONT_VALUE) {
                    alert('ä¸èƒ½åˆ é™¤é»˜è®¤å­—ä½“ã€‚');
                    return;
                }
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤å­—ä½“ "${fontSelect.options[fontSelect.selectedIndex].text}" å—ï¼Ÿ`)) {
                    let fonts = JSON.parse(localStorage.getItem(FONT_DB_KEY) || '[]');
                    fonts = fonts.filter(font => font.family !== selectedFontFamily);
                    localStorage.setItem(FONT_DB_KEY, JSON.stringify(fonts));
                    
                    loadFontsFromStorage(); // åˆ·æ–°
                    applyFont(DEFAULT_FONT_VALUE); // æ¢å¤é»˜è®¤
                }
            });


            // ----------------------------------------
            // 14. V15.0 å¯åŠ¨/åˆ‡æ¢é€»è¾‘
            // ----------------------------------------
            
            function saveLastPosition() {
                // V16.0 ä¿®å¤ï¼šåªæœ‰åœ¨æ¸¸æˆå†…æ‰ä¿å­˜
                if (gameContainer.style.display === 'none' || gameState === 'modal') return;
                const line = (currentLine > 0) ? currentLine - 1 : 0;
                localStorage.setItem(LAST_POS_PREFIX + currentStoryName, line);
            }
            
            function showTitleScreen() {
                saveLastPosition();
                stopAuto(); stopSkip();
                
                gameContainer.style.display = 'none';
                storyEndScreen.style.display = 'none'; // V19.0 éšè—
                // V20.1 ä¿®å¤ï¼šæ ‡é¢˜ç”»é¢ä¸åº”æ˜¾ç¤ºæ¸¸æˆèœå•æŒ‰é’®
                menuBtn.style.display = 'none'; 
                
                // é‡æ–°æ£€æŸ¥ç»§ç»­æŒ‰é’®
                const lastName = localStorage.getItem(LAST_STORY_KEY) || DEFAULT_STORY_NAME;
                const lastLine = parseInt(localStorage.getItem(LAST_POS_PREFIX + lastName) || 0, 10);
                titleContinueBtn.disabled = (lastLine <= 0);
                
                titleScreen.style.display = 'flex';
                gameState = 'modal'; // V15.0 æ ‡é¢˜ = modal
            }
            
            // V15.0 å¯åŠ¨/åˆ‡æ¢æ•…äº‹çš„ç»Ÿä¸€å…¥å£
            function startGame(name, lineIndex) {
                // V16.0 ä¿®å¤ï¼šå¦‚æœæ•…äº‹ä¸å­˜åœ¨ï¼Œåˆ™ä¸­æ­¢
                const db = storyDB.getAll();
                if (!db[name]) {
                    alert(`é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ•…äº‹ã€Š${name}ã€‹ã€‚`);
                    localStorage.removeItem(LAST_STORY_KEY);
                    showTitleScreen();
                    return;
                }
                
                loadStory(name);
                jumpToLine(lineIndex, lineIndex > 0); // V15.0: åªæœ‰ > 0 æ‰é‡å»ºå†å²
                
                titleScreen.style.display = 'none';
                gameContainer.style.display = 'flex';
                // V20.1 ä¿®å¤ï¼šæ¸¸æˆå¼€å§‹æ—¶æ˜¾ç¤ºèœå•æŒ‰é’®
                menuBtn.style.display = 'flex';
                
                gameState = 'idle';
            }
            
            function loadStory(name) {
                const db = storyDB.getAll();
                const text = db[name]; // V16.0 ä¿®å¤ï¼šå¯åŠ¨æ—¶å·²æ£€æŸ¥ï¼Œæ— éœ€å›é€€
                
                currentStoryName = name;
                localStorage.setItem(LAST_STORY_KEY, name);
                
                storyData = parseStoryText(text);
                
                // é‡ç½®æ‰€æœ‰çŠ¶æ€ (ä½†ä¸æ˜¾ç¤º)
                currentLine = 0;
                logHistory = [];
                logContent.innerHTML = '';
                sectionTitle.classList.remove('show');
                dialogueBox.classList.remove('show');
                sceneTitle.classList.remove('show');
                sceneTransition.classList.remove('show', 'slide-out');
                stopAuto();
                stopSkip();
                clearTimeout(sceneTimeout);
            }

            // ----------------------------------------
            // 15. åˆå§‹åŒ–
            // ----------------------------------------
            function init() {
                // 1. V19.0 å¡«å……æç¤ºè¯
                promptPreBlock.textContent = AI_CONVERT_PROMPT;
                // 2. åŠ è½½å­—ä½“
                loadFontsFromStorage();
                applyLastFont();
                // 3. æ˜¾ç¤ºæ ‡é¢˜
                showTitleScreen();
            }
            
            init();

        }); // DOMContentLoaded ç›‘å¬å™¨ç»“æŸ
    </script>
</body>
</html>
